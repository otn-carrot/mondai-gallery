<template>
  <div>
  <div class="card mb">
    <div class="card-content">
      <p class="title">{{mondaiList.name}}</p>
      <p class="subtitle"><a @click="to(profileUrl())">{{mondaiList.editor.nickname}}</a></p>
      <p class="multiline card-body">{{mondaiList.description}}</p>
    </div>
  </div>
    <div class="panel">
      <div class="panel-heading">
        <div class="level">
          <div class="level-left">
            <div class="level-item">
              <span class="mr">サイト</span>
              <b-select placeholder="Select a name" v-model="siteFilter">
                <option v-for="item in siteList" :value="item.key" :key="item.key">{{item.value.name}}</option>
              </b-select>
            </div>
            <div class="level-item">
              <span class="mr">ジャンル</span>
              <b-select placeholder="Select a genre" v-model="genreFilter">
                <option v-for="item in genreList" :value="item.key" :key="item.key">{{item.value}}</option>
              </b-select>
            </div>
            <div class="level-item">
              <a class="button is-outlined is-danger" v-on:click='clearFilter()'>クリア</a>
            </div>
          </div>
          <div class="level-right">
            <div class="level-item">
              <span class="mr">表示</span>
              <b-select v-model='detail'>
                <option :value="false">リスト</option>
                <option :value="true">詳細</option>
              </b-select>
            </div>
            <div class="level-item">
              <button class="button is-outlined is-secondary" @click="$router.push(editUrl())" v-if="isMine">編集</button>
            </div>
          </div>
        </div>
      </div>
      <a class="panel-block" v-for="item in filter(mondaiList.mondai)" v-bind:key="item._id" target='_blank' v-bind:href='url(item.site,item.id)'>
        <div v-if="detail">
          <mondai-view v-bind:item="item"></mondai-view>
        </div>
        <div class="level" v-else>
          <div class="level-left">
            <div class="level-item">
            <small>{{item.author}}</small>
            <span>{{ item.title }}</span>
            </div>
          </div>
          <div class="level-right">
            <b-tag class="is-primary level-item">{{site[item.site].name}}</b-tag>
            <b-tag class="is-info level-item">{{genre[item.genre]}}</b-tag>
          </div>
        </div>
      </a>
    </div>
    <!-- 次に見る -->
    <div class="panel">
      <div class="panel-heading">
        <b-icon icon="arrow-right-drop-circle-outline"></b-icon><span>次に見る</span>
      </div>
      <list-link :item="item" v-for="item in otherList" v-bind:key="item.id"></list-link>
    </div>
  </div>
</template>
<script>
export default {
  data () {
    return {
      name: 'MondaiList',
      genreFilter: 'all',
      siteFilter: 'all',
      detail: false,
      isMine: false,
      otherList: [],
      mondaiList: {
        'name': '-',
        'description': '-',
        'editor': {
          'id': 0,
          'username': '-',
          'nickname': '-'
        },
        'mondai': [{
          'id': 0,
          'title': '-',
          'author': '-',
          'site': 'latethink',
          'description': '-',
          'genre': 'umigame'
        }]
      }
    }
  },
  computed: {
    site: function () {
      return this.$store.state.site
    },
    siteList: function () {
      let list = [{key: 'all', value: {'name': 'すべて'}}]
      for (let key in this.$store.state.site) {
        list.push({key: key, value: this.$store.state.site[key]})
      }
      return list
    },
    genre: function () {
      return this.$store.state.genre
    },
    genreList: function () {
      let list = [{key: 'all', value: 'すべて'}]
      for (let key in this.$store.state.genre) {
        list.push({key: key, value: this.$store.state.genre[key]})
      }
      return list
    }
  },
  watch: {
    '$route' (to, from) {
      this.fetchList()
    }
  },
  mounted: function () {
    this.fetchList()
  },
  methods: {
    url: function (siteName, id) {
      return this.site[siteName].showUrl + id
    },
    editUrl: function () {
      return '/mondaiList/edit/' + this.mondaiList.id
    },
    profileUrl: function () {
      return '/profile/show/' + this.mondaiList.editor.id
    },
    to: function (url) {
      this.$router.push(url)
    },
    filter: function (mondai) {
      let filtered = mondai
      // ジャンル
      if (this.genreFilter !== 'all') filtered = filtered.filter(x => x.genre === this.genreFilter)
      // サイト
      if (this.siteFilter !== 'all') filtered = filtered.filter(x => x.site === this.siteFilter)

      return filtered
    },
    sort: function (mondai) {
      let sorted = mondai.sort((x,y)=> {
        return x._id - y._id
      })
      return sorted
    },
    clearFilter: function () {
      this.genreFilter = 'all'
      this.siteFilter = 'all'
    },
    fetchList: function () {
      var vm = this
      var id = this.$route.params.id
      this.$http.get(this.$endPoint('/api/mondaiList/show/' + id))
        .then(function (response) {
          vm.mondaiList = response.data
          vm.mondaiList.mondai = vm.sort(vm.filter(vm.mondaiList.mondai))
          vm.$http.get(vm.$endPoint('/api/mondaiList'))
            .then(function (res) {
              vm.otherList = res.data.filter(x => x.editor.id === vm.mondaiList.editor.id && x.id !== vm.mondaiList.id)
            })
        })
        .catch(function (err) {
          if (err) {
            this.$toast.open({
              'message': 'エラー',
              'type': 'is-danger'
            })
          }
        })
        .then(function () {
          vm.$http.get(vm.$endPoint('/api/user'))
            .then((res) => {
              if (res) {
                if (res.data) {
                  if (res.data.username === vm.mondaiList.editor.username) {
                    vm.isMine = true
                  }
                }
              }
            })
        })
    }
  }
}
</script>
<style scoped>
.level {
  width: 100%;
}
.tag {
  min-width: 100px;
}
.mr {
  margin-right: 5px;
}
.mb {
  margin-bottom: 10px;
}
small {
  margin-right: 5px;
}
</style>
